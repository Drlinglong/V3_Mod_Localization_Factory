# 🏗️ 项目架构

> 系统设计说明和技术架构详解

## 🎯 设计原则

### 模块化设计
- **高内聚**: 每个模块职责单一，功能完整
- **低耦合**: 模块间依赖关系清晰，易于维护
- **可扩展**: 支持新功能模块的快速集成

### 分层架构
- **表现层**: 用户界面和交互逻辑
- **业务层**: 核心业务逻辑和工作流
- **数据层**: 数据存储和访问接口
- **基础设施层**: 通用工具和第三方服务

## 🏛️ 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  main.py                    # 主程序入口                     │
│  └── 菜单系统、用户交互、流程控制                              │
├─────────────────────────────────────────────────────────────┤
│                    工作流层 (Workflow Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  workflows/                                                 │
│  ├── initial_translate.py   # 首次翻译工作流                 │
│  ├── generate_workshop_desc.py # 工坊描述生成                │
│  └── ...                    # 其他工作流                     │
├─────────────────────────────────────────────────────────────┤
│                    核心引擎层 (Core Engine Layer)             │
├─────────────────────────────────────────────────────────────┤
│  core/                                                      │
│  ├── api_handler.py         # API统一接口                    │
│  ├── glossary_manager.py    # 词典管理系统                   │
│  ├── file_parser.py         # 文件解析器                     │
│  ├── file_builder.py        # 文件构建器                     │
│  ├── directory_handler.py   # 目录处理器                     │
│  ├── asset_handler.py       # 资源处理器                     │
│  ├── proofreading_tracker.py # 校对追踪器                    │
│  ├── parallel_processor.py  # 并行处理器                     │
│  └── ...                    # 其他核心模块                   │
├─────────────────────────────────────────────────────────────┤
│                    工具层 (Utility Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  utils/                                                     │
│  ├── i18n.py               # 国际化支持                     │
│  ├── logger.py              # 日志系统                      │
│  ├── text_clean.py          # 文本清理工具                   │
│  └── ...                    # 其他工具模块                   │
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────┤
│  data/                                                      │
│  ├── lang/                  # 语言文件                      │
│  │   ├── en_US.json        # 英文界面                      │
│  │   └── zh_CN.json        # 中文界面                      │
│  ├── glossary/              # 词典数据                      │
│  │   ├── victoria3/        # V3专用词典                    │
│  │   ├── stellaris/        # 群星专用词典                   │
│  │   └── ...               # 其他游戏词典                   │
│  └── config/                # 配置文件                      │
├─────────────────────────────────────────────────────────────┤
│                    配置层 (Configuration Layer)              │
├─────────────────────────────────────────────────────────────┤
│  config.py                  # 全局配置                      │
│  ├── 游戏档案配置                                            │
│  ├── API配置                                                │
│  ├── 系统参数                                               │
│  └── 常量定义                                               │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 核心模块详解

### 1. 主程序入口 (`main.py`)
**职责**: 程序启动、用户交互、流程协调
**特点**: 
- 统一的入口点
- 模块化的菜单系统
- 异常处理和错误恢复

### 2. 工作流引擎 (`workflows/`)
**职责**: 业务流程编排、任务调度
**特点**:
- 可配置的工作流定义
- 支持条件分支和循环
- 状态管理和进度跟踪

### 3. API处理器 (`core/api_handler.py`)
**职责**: 统一管理各种AI翻译API
**特点**:
- 抽象化API接口
- 支持多种服务商
- 错误重试和降级机制

### 4. 词典管理器 (`core/glossary_manager.py`)
**职责**: 游戏术语词典的加载、管理和应用
**特点**:
- 支持多游戏词典
- 模糊匹配算法
- 动态词典更新

### 5. 文件解析器 (`core/file_parser.py`)
**职责**: 解析P社特有的文件格式
**特点**:
- 支持多种.yml格式
- 容错性解析
- 保持原始格式

### 6. 并行处理器 (`core/parallel_processor.py`)
**职责**: 多文件、多批次的并行处理
**特点**:
- 智能线程池管理
- 负载均衡
- 资源优化

## 🔄 数据流

### 翻译流程
```
用户输入 → 文件解析 → 词典注入 → API翻译 → 结果验证 → 文件重建 → 输出
```

### 数据流向
```
源文件 → 解析器 → 文本提取 → 词典匹配 → AI翻译 → 质量检查 → 文件生成
```

## 🎮 游戏档案系统

### 配置结构
```python
GAME_PROFILES = {
    "victoria3": {
        "name": "Victoria 3",
        "localization_dir": "localization",
        "metadata_file": ".metadata/metadata.json",
        "supported_languages": [...],
        "file_patterns": [...]
    }
}
```

### 扩展性
- 新游戏只需添加配置文件
- 支持自定义文件结构
- 灵活的语言配置

## 🔌 插件系统

### Hook机制
- 文件解析钩子
- 翻译后处理钩子
- 自定义输出格式钩子

### 扩展点
- 新的AI服务商
- 新的文件格式
- 新的输出格式

## 📊 性能优化

### 并行处理
- 多文件并行
- 多批次并行
- 智能线程池

### 内存管理
- 流式处理大文件
- 及时释放资源
- 缓存优化

### 网络优化
- API调用批处理
- 重试机制
- 超时控制

## 🔒 安全考虑

### 数据安全
- API密钥环境变量
- 敏感信息不记录日志
- 临时文件及时清理

### 错误处理
- 优雅降级
- 详细错误日志
- 用户友好的错误提示

## 🚀 未来扩展

### 计划中的功能
- Web界面
- 数据库支持
- 云端部署
- 社区词典共享

### 技术升级
- 异步编程
- 微服务架构
- 容器化部署

---

> 📚 **相关文档**: 
> - [并行处理技术](docs/developer/parallel-processing.md)
> - [实现记录](docs/developer/implementation-notes.md)
> - [词典系统](docs/glossary/overview.md)
