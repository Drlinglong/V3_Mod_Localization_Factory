# 🏗️ 项目架构

> 系统设计说明和技术架构详解

## 🎯 设计原则

### 模块化设计
- **高内聚**: 每个模块职责单一，功能完整
- **低耦合**: 模块间依赖关系清晰，易于维护
- **可扩展**: 支持新功能模块的快速集成

### 分层架构
- **表现层**: 用户界面和交互逻辑
- **业务层**: 核心业务逻辑和工作流
- **数据层**: 数据存储和访问接口
- **基础设施层**: 通用工具和第三方服务

## 🏛️ 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  main.py                    # 主程序入口                     │
│  └── 菜单系统、用户交互、流程控制                              │
├─────────────────────────────────────────────────────────────┤
│                    工作流层 (Workflow Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  workflows/                                                 │
│  ├── initial_translate.py   # 首次翻译工作流                 │
│  └── ...                    # 其他工作流                     │
├─────────────────────────────────────────────────────────────┤
│                    核心引擎层 (Core Engine Layer)             │
├─────────────────────────────────────────────────────────────┤
│  core/                                                      │
│  ├── api_handler.py         # API统一接口                    │
│  ├── glossary_manager.py    # 词典管理系统                   │
│  ├── file_parser.py         # 文件解析器                     │
│  ├── file_builder.py        # 文件构建器                     │
│  ├── directory_handler.py   # 目录处理器                     │
│  ├── asset_handler.py       # 资源处理器                     │
│  ├── proofreading_tracker.py # 校对追踪器                    │
│  ├── post_processing_manager.py # 后处理管理器               │
│  ├── parallel_processor.py  # 并行处理器                     │
│  └── ...                    # 其他核心模块                   │
├─────────────────────────────────────────────────────────────┤
│                    工具层 (Utility Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  utils/                                                     │
│  ├── i18n.py               # 国际化支持                     │
│  ├── logger.py              # 日志系统                      │
│  ├── text_clean.py          # 文本清理工具                   │
│  ├── post_process_validator.py # 后处理验证器               │
│  ├── punctuation_handler.py # 标点符号处理器                 │
│  └── ...                    # 其他工具模块                   │
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────┤
│  data/                                                      │
│  ├── lang/                  # 语言文件                      │
│  │   ├── en_US.json        # 英文界面                      │
│  │   └── zh_CN.json        # 中文界面                      │
│  ├── glossary/              # 词典数据                      │
│  │   ├── victoria3/        # V3专用词典                    │
│  │   ├── stellaris/        # 群星专用词典                   │
│  │   └── ...               # 其他游戏词典                   │
│  └── config/                # 配置文件                      │
├─────────────────────────────────────────────────────────────┤
│                    配置层 (Configuration Layer)              │
├─────────────────────────────────────────────────────────────┤
│  config.py                  # 全局配置                      │
│  ├── 游戏档案配置                                            │
│  ├── API配置                                                │
│  ├── 系统参数                                               │
│  └── 常量定义                                               │
└─────────────────────────────────────────────────────────────┘
```

#### **自动化翻译核心**
* **多API支持**: 支持Gemini、OpenAI、Qwen等多种AI翻译服务，用户可根据需要选择。
* **Gemini CLI支持**: 新增支持Gemini CLI，每天提供1000次免费的Gemini 2.5 Pro调用，无需API密钥，使用Google账户OAuth认证即可享受高质量的AI翻译服务。
* **智能词典系统**: 内置游戏专用词典管理器，自动识别并注入相关术语，确保游戏术语翻译的一致性和准确性。
* **稳健的解析器**: 内置专为应对P社“花式”`.yml`格式（如 `key:0 "value"`）而设计的解析器，确保所有有效文本都能被准确提取。
* **智能分批处理 (Chunking)**: 面对包含数百上千条文本的大型文件，脚本会自动将其分批次处理，以保证API调用的稳定性和成功率。
* **高保真重建**: 在重建文件时，能完美保留原始文件的缩进、注释和复杂的键名格式。

#### **多游戏/多语言支持**
* **多游戏档案**: 通过`config.py`中的游戏档案系统，可为不同P社游戏（目前已内置维多利亚3和群星的配置）定义不同的文件结构、Prompt模板和处理规则。
* **多语言互译**: 支持在官方支持的多种语言之间，选择任意一种作为源语言，翻译为另一种目标语言。
* **"一键多语"模式**: 支持将一个源语言版本，一键批量翻译为其余所有游戏官方支持的语言。不同游戏支持的语言数量不同：
  - 维多利亚3：11种官方语言
  - 群星：10种官方语言  
  - 钢铁雄心4：9种官方语言
  - 十字军之王3：8种官方语言
  - 欧陆风云4：4种官方语言

> **⚠️ 重要说明**: 由于欧陆风云4（EU4）的引擎限制，目前我们的项目**不支持对EU4的中文本地化**。EU4使用的是较老的Clausewitz引擎版本，其本地化系统与较新的P社游戏存在根本性差异，无法通过我们的工具正确处理中文字符编码和文件结构。虽然我们提供了EU4的词典支持，但实际的本地化功能暂不可用。
* **动态文件生成**: 能够根据选择的目标语言和游戏，自动生成符合规范的文件名（如 `..._l_french.yml`）、文件头（如 `l_french:`）和文件夹名（如 `fr-Mod名`）。
* **自定义目标语言支持**: 在目标语言选择列表末尾提供"[c] 自定义目标语言..."选项，支持用户创建非官方语言或"套壳"语言包：
  - **目标语言名称**: 用于向AI下达翻译指令（如：Italian）
  - **P社内部语言密钥**: 用于生成.yml文件的文件头（如：l_italian 或 l_english用于"套壳"）
  - **输出文件夹前缀**: 用于生成本地化包的顶层文件夹名（如：IT-）
  - **兼容"套壳"模式**: 支持将翻译内容伪装成英文文件，解决某些社区将Mod翻译成母语但伪装成英文文件的问题

#### **完整的Mod包处理**
* **深度文件扫描**: 自动递归遍历本地化文件夹下的所有子目录，确保不遗漏任何`.yml`文件。
* **智能元数据处理**: 能够根据游戏档案，自动处理并翻译维多利亚3的`.metadata/metadata.json`文件和群星的`descriptor.mod`文件（并生成两份）。
* **配套资源复制**: 自动将游戏档案中定义的关键资产（如 `thumbnail.png`, `descriptor.mod`）复制到本地化文件夹。
* **上下文感知翻译**: 在翻译元数据时，会读取Mod名称并允许用户输入额外的主题信息，将这些上下文注入到Prompt中，以提升AI翻译的准确性。

#### **国际化与工作流管理**
* **双语用户界面 (i18n)**: 脚本自身的命令行交互界面，支持中英双语切换。
* **智能校对进度追踪**: 自动生成CSV格式的校对进度表，支持中英文界面，帮助汉化者追踪和管理校对工作。
* **后处理格式验证**: 翻译完成后自动运行格式验证，检测语法错误、格式问题和标签配对，生成详细的验证报告。
* **安全回退机制**: 当API调用失败时，会自动创建一份保留原文的备用文件，以保证Mod在游戏中的完整性。
* **可选的源目录清理**: 在所有操作成功后，提供可选的清理功能，并根据游戏档案精确地保留必要文件。
  
## 🔧 核心模块详解

### 1. 主程序入口 (`main.py`)
**职责**: 程序启动、用户交互、流程协调
**特点**: 
- 统一的入口点
- 模块化的菜单系统
- 异常处理和错误恢复

### 2. 工作流引擎 (`workflows/`)
**职责**: 业务流程编排、任务调度
**特点**:
- 可配置的工作流定义
- 支持条件分支和循环
- 状态管理和进度跟踪

### 3. API处理器 (`core/api_handler.py`)
**职责**: 统一管理各种AI翻译API
**特点**:
- 抽象化API接口
- 支持多种服务商
- 错误重试和降级机制

### 4. 词典管理器 (`core/glossary_manager.py`)
**职责**: 游戏术语词典的加载、管理和应用
**特点**:
- 支持多游戏词典
- 模糊匹配算法
- 动态词典更新

### 5. 文件解析器 (`core/file_parser.py`)
**职责**: 解析P社特有的文件格式
**特点**:
- 支持多种.yml格式
- 容错性解析
- 保持原始格式

### 6. 并行处理器 (`core/parallel_processor.py`)
**职责**: 实现真正的多文件并行处理，解决文件级阻塞问题，显著提升翻译效率。
**特点**:
- **核心组件**: `FileTask` (文件任务数据结构)、`BatchTask` (批次任务数据结构)、`ParallelProcessor` (并行处理器主类)。
- **关键特性**: 将文件任务分解为批次任务，使用线程池并行处理所有批次，智能结果收集和文件重建，容错和错误恢复机制。
- **性能提升**: 相较于旧架构，实现了显著的加速比（例如，测试中达到5.52倍加速），充分利用系统资源。

### 7. 后处理管理器 (`core/post_processing_manager.py`)
**职责**: 负责翻译后的文本格式验证、报告生成以及其他后处理任务。
**特点**:
- 格式验证与修复：确保翻译文本符合P社游戏特定的格式要求。
- 报告生成：提供详细的后处理报告，帮助用户发现和解决问题。
- 可扩展性：支持添加新的后处理插件和规则。

### 8. 后处理验证器 (`utils/post_process_validator.py`)
**职责**: 提供游戏特定的语法规则验证，确保翻译后的文本在游戏中正确显示。
**特点**:
- 游戏特定规则：针对不同P社游戏（如Victoria 3, Stellaris, HOI4）的本地化语法进行验证。
- 错误检测：识别并报告格式错误、缺失的占位符等问题。
- 高度可配置：支持自定义验证规则和错误级别。

### 9. 标点符号处理器 (`utils/punctuation_handler.py`)
**职责**: 处理多语言标点符号的转换和清理，确保标点符号的正确使用。
**特点**:
- 三层架构：包括核心清理函数、分析函数和主接口函数，职责清晰。
- 智能映射：支持目标语言特定的标点符号映射，提高准确性。
- 消除重复代码：遵循DRY原则，所有清理逻辑集中管理。

## 🔄 数据流

### 翻译流程
```
用户输入 → 文件解析 → 词典注入 → API翻译 → 结果验证 → 文件重建 → 输出
```

### 数据流向
```
源文件 → 解析器 → 文本提取 → 词典匹配 → AI翻译 → 质量检查 → 文件生成
```

## 🎮 游戏档案系统

### 配置结构
```python
GAME_PROFILES = {
    "victoria3": {
        "name": "Victoria 3",
        "localization_dir": "localization",
        "metadata_file": ".metadata/metadata.json",
        "supported_languages": [...],
        "file_patterns": [...]
    }
}
```

### 扩展性
- 新游戏只需添加配置文件
- 支持自定义文件结构
- 灵活的语言配置

## 🔌 插件系统

### Hook机制
- 文件解析钩子
- 翻译后处理钩子
- 自定义输出格式钩子

### 扩展点
- 新的AI服务商
- 新的文件格式
- 新的输出格式

## 📊 性能优化

### 并行处理
本项目通过引入全新的并行处理器架构，实现了真正的多文件并行处理，显著提升了翻译效率。
- **多文件并行**：同时处理多个Mod文件，避免文件级阻塞。
- **多批次并行**：将每个文件分解为多个批次，并行处理所有批次。
- **智能线程池**：优化线程资源管理，充分利用多核CPU能力。
- **性能数据**：在测试中，相较于旧架构，实现了高达5.52倍的加速比，效率提升451.7%。

### 内存管理
- 流式处理大文件
- 及时释放资源
- 缓存优化

### 网络优化
- API调用批处理
- 重试机制
- 超时控制

## 🔒 安全考虑

### 数据安全
- API密钥环境变量
- 敏感信息不记录日志
- 临时文件及时清理

### 错误处理
- 优雅降级
- 详细错误日志
- 用户友好的错误提示

## 🚀 未来扩展

### 计划中的功能
- Web界面
- 数据库支持
- 云端部署
- 社区词典共享

### 技术升级
- 异步编程
- 微服务架构
- 容器化部署

---

> 📚 **相关文档**: 
> - [并行处理技术](docs/developer/parallel-processing.md)
> - [实现记录](docs/developer/implementation-notes.md)
> - [词典系统](docs/glossary/overview.md)
