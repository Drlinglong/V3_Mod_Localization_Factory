# 技术文档：`response_parser.py` 终极防御性重构

**日期:** 2025-10-12 (最终修复版)
**作者:** Jules

## 1. 背景与问题

项目的核心翻译流程严重依赖于上游LLM返回的JSON格式数据。然而，实践证明，LLM的输出极不稳定，频繁返回包含各类语法错误的JSON响应。经过深入分析，我们识别出两大类致命的“数据投毒”模式：

1.  **结构性截断 (贪婪陷阱)**: 当JSON字符串内容本身包含 `[` 或 `]` 字符时，简单的提取方法（无论是贪婪/非贪婪正则表达式，还是简单的 `find`/`rfind`）都会错误地提前结束匹配，导致提取出的JSON数组被截断，引发 `Unterminated string` 错误。
2.  **合法性破坏 (修复风暴)**: 用于修复缺失逗号的逻辑存在缺陷，它会错误地修改包含换行符 (`\n`) 的、本应合法的JSON字符串，画蛇添足地加入无效的逗号，最终导致 `Invalid control character` 错误。
3.  **连锁性失效 (Heuristic Failure)**: 用于处理嵌套JSON响应的启发式逻辑存在缺陷，其判断条件不正确，导致关键的修复步骤被跳过，使得一个本可修复的错误最终导致解析失败。

为了根除这些顽固的bug，我们对 `scripts/utils/response_parser.py` 的核心算法和架构进行了最终的、决定性的重构。

## 2. 设计哲学：多层防御、状态跟踪与“先试后修”

### 核心架构：“先审判，后手术”

- **旧架构的缺陷**: 无论输入是否合法，都强制其通过高风险的“外科手术”流程，导致了对合法JSON的“修复风暴”。
- **新架构**:
    1.  对提取出的文本 **首先尝试直接解析 (`json.loads`)**。
    2.  如果成功，则立即返回结果。
    3.  **只有在直接解析失败后**，才将文本送入“外科医生”(`_run_repair_surgeries`)进行修复，然后再次尝试解析。
- **优势**: 从根本上保证了合法的JSON（即使包含换行符）不会被不必要的手术所破坏。

### 详细防御层次

#### 第0道防线：智能分诊 (The Triage)
- **目标**: 区分“需要解包的嵌套JSON对象”和“普通的脏字符串”。
- **实现**:
    1.  尝试将完整输入解析为JSON对象。
    2.  如果成功且结构是预期的 `{"response": "..."}`，则提取内部字符串作为处理目标，并设置一个内部状态标志 `was_unwrapped = True`。
    3.  如果不是预期的字典结构，则立即失败回退。
    4.  如果无法解析为JSON对象，则假定为“脏字符串”，继续后续流程。

#### 第一道防线：平衡括号提取器 (The Balanced Bracket Extractor)
- **目标**: 取代旧的、不可靠的净化器，精确提取最外层的完整JSON数组。
- **实现**:
    1.  找到第一个 `[`。
    2.  从该位置开始，使用一个计数器 (`balance_counter`) 逐字符扫描。遇到 `[` 加一，遇到 `]` 减一。
    3.  算法会跟踪是否处于字符串中 (`in_string` 状态)，并忽略字符串内的括号。
    4.  当计数器首次归零时，对应的 `]` 就是精确匹配的结束括号。
- **优势**: 对字符串内容中任意数量的 `[` 或 `]` 完全免疫，根除了“贪婪陷阱”。

#### 启发式修复 (Heuristic Repair)
- **目标**: 修复因“分诊”解包后，内部字符串残留的转义引号 (`\"`)。
- **实现**: **(关键修复)** 废除了基于字符串内容的猜测，现在使用 `if was_unwrapped:` 作为判断条件。
- **优势**: 只有在“分诊”步骤明确进行了解包操作后，才执行 `replace('\\"', '"')`，确保了修复的精确性和确定性，解决了连锁失败问题。

#### 第二道防线：外科医生 (The Surgeon)
- **目标**: 对（且仅对）初次解析失败的字符串进行精细修复。
- **实现**:
    1.  **修复缺失的逗号 (安全版)**:
        - **(关键修复)** 旧的 `[ \t]*` 正则表达式过于保守。在新架构的保护下，我们可以安全地将正则表达式恢复为 `\s*`。
        - **新的实现** 使用 `re.sub(r'(?<!\\)"\s*(?<!\\)"', '","', ...)`，它现在既能处理空格/制表符，也能正确修复由换行符分隔的缺失逗号问题。
    2.  其他手术逻辑保持不变。

#### 第三道防线：审判者 (The Judge)
- **目标**与**实现**保持不变：对修复后的字符串进行最终的 `json.loads()` 解析尝试。

#### 最终防御预案：永不崩溃 (The Ultimate Fallback)
- **实现**保持不变：在任何不可恢复的失败情况下，记录日志并返回原始输入列表。

## 3. 极限压力测试
测试套件 `tests/utils/test_response_parser.py` 已被大幅扩展，以验证所有新的修复和架构变更：
- **(新)** `expecting_comma_delimiter_regression`: 精确复现并验证了由 `was_unwrapped` 修复的连锁失败问题。
- **(新)** `bracket_balancer_stress_test`: 验证“平衡括号提取器”在复杂嵌套括号下的健壮性。
- **(新)** `surgeon_newline_safety_test`: 验证“外科医生”在新架构下能安全处理包含 `,\n` 的合法结构，同时也能修复 `"\n"` 的非法结构。

所有测试现已全部通过，证明了最终修复方案的全面健壮性。
