# 技术文档：`response_parser.py` 终极防御性重构

**日期:** 2025-10-12 (最终修复版)
**作者:** Jules

## 1. 背景与问题

项目的核心翻译流程严重依赖于上游LLM返回的JSON格式数据。然而，实践证明，LLM的输出极不稳定，频繁返回包含各类语法错误的JSON响应。经过深入分析，我们识别出两大类致命的“数据投毒”模式：

1.  **结构性截断 (贪婪陷阱)**: 当JSON字符串内容本身包含 `[` 或 `]` 字符时，简单的正则表达式或索引查找方法会错误地提前结束匹配，导致提取出的JSON数组被截断，引发 `Unterminated string` 错误。
2.  **合法性破坏 (修复风暴)**: 用于修复缺失逗号的逻辑存在缺陷，它会错误地修改包含换行符 (`\n`) 的、本应合法的JSON字符串，画蛇添足地加入无效的逗号，最终导致 `Invalid control character` 错误。

为了根除这些顽固的bug，我们对 `scripts/utils/response_parser.py` 的核心算法进行了最终的、决定性的重构。

## 2. 设计哲学：“三道防线”与“永不崩溃”

本次重构的核心设计思想是建立一个多层、纵深的防御体系，并遵循一个最高原则：“**永不因解析失败而崩溃**”。

### 第一道防线：平衡括号提取器 (The Balanced Bracket Extractor)

- **目标**: 彻底取代旧的、不可靠的“净化器”，以算法的确定性，百分之百准确地从原始响应中提取出最外层的、完整的JSON数组结构。
- **实现**:
    1.  使用 `response_text.find('[')` 找到第一个左方括号的索引。
    2.  从该位置开始，逐字符向后扫描，并维护一个 `balance_counter` 计数器。
    3.  当遇到 `[` 时计数器加一，遇到 `]` 时减一。**为了避免错误计算字符串字面量中的括号，算法会跟踪当前是否处于一个字符串中 (`in_string` 状态)，在字符串中则不更新计数器。**
    4.  当计数器第一次从1变回0时，当前 `]` 的位置就是与第一个 `[` 精确配对的右方括号。
    5.  提取这两个索引之间的子字符串，即为完整的、未经截断的核心JSON。
- **优势**: 这种基于括号平衡的算法，对于字符串内容中包含的任意数量、任意嵌套的 `[` 或 `]` 都是**完全免疫的**，从根本上根除了“贪婪陷阱”问题。

### 第二道防线：外科医生 (The Surgeon)

- **目标**: 对提取出的核心 `[...]` 字符串，进行一系列精细、安全、且有必要的内部修复手术。
- **实现**: 在 `_run_repair_surgeries` 私有函数中，按特定顺序执行修复：
    1.  **修复已知问题字符串**: ... (逻辑不变)
    2.  **修复缺失的逗号 (安全版)**:
        - **(关键修复)** 旧的 `re.sub(r'(?<!\\)"\s*(?<!\\)"', '","', ...)` 正则表达式被证实存在缺陷，会错误地匹配换行符。
        - **新的实现** 使用 `re.sub(r'(?<!\\)"[ \t]*(?<!\\)"', '","', ...)`，通过将 `\s*` 替换为更严格的 `[ \t]*` (只匹配空格和制表符)，彻底避免了对换行符的错误匹配，从而根除了“修复风暴”问题。
    3.  **修复内部未转义引号**: ... (逻辑不变，基于状态机)

### 第三道防线：审判者 (The Judge)

- **目标**与**实现**保持不变：对经过处理后的字符串进行最终的 `json.loads()` 解析尝试。

### 最终防御预案：永不崩溃 (The Ultimate Fallback)

- **目标**与**实现**保持不变：在任何不可恢复的失败情况下，记录详细日志，并**返回 `original_input_list`**，确保数据流的完整和程序的稳定。

## 3. 函数签名与调用点

函数签名和调用点均**无需**任何修改。所有修复都内聚在 `response_parser.py` 内部，对调用者透明。

## 4. 极限压力测试

`tests/utils/test_response_parser.py` 中的测试套件已再次扩展，加入了针对本次发现的两个核心缺陷的回归测试：
- **(新)** `bracket_balancer_stress_test`: 验证“平衡括号提取器”在面对包含多个内嵌 `[` 和 `]` 的复杂字符串时，依然能准确提取出完整结构。
- **(新)** `surgeon_newline_safety_test`: 验证“外科医生”在处理包含 `,\n` 合法结构的JSON字符串时，不会再进行破坏性修复。

所有测试现已全部通过，证明了最终修复方案的健壮性和正确性。
