# 数据库文档：崩溃安全工作流 (`translation_progress.sqlite`)

本文档详细说明了为实现“初次翻译”工作流的崩溃安全（Crash Safety）和断点续传（Resumability）功能而引入的新数据库 `translation_progress.sqlite`。

## 1. 设计目标

传统的翻译流程将所有中间结果保存在内存中，一旦程序意外中断（如崩溃、断电），所有未保存的进度都会丢失。`translation_progress.sqlite` 的核心设计目标就是解决这一问题，确保翻译过程的**健壮性和可恢复性**。

它遵循“聚合器模式”，将工作流彻底解耦为两个阶段：
- **生产阶段**：并行地将翻译好的文本批次（batch）**立即**写入数据库。
- **消费阶段**：在所有生产任务完成后，从数据库中安全地读取所有批次，并**有序地**组装成最终文件。

这个数据库是一个**临时进度记录器**，而非长期归档库。

## 2. 数据库位置

- **路径**: `data/translation_progress.sqlite`

该文件会在第一次运行新的翻译工作流时自动创建。

## 3. 表结构 (`translated_batches`)

数据库包含一个核心表 `translated_batches`，用于存储已成功翻译并验证的文本批次。

| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `job_id` | `TEXT` | **[主键]** 唯一标识一次完整的翻译任务。格式通常为 `Mod名-目标语言代码-时间戳`。 |
| `file_path` | `TEXT` | **[主键]** 该批次所属的**完整**源文件路径。 |
| `batch_index` | `INTEGER` | **[主key]** 批次在该文件内的顺序索引（从 0 开始）。 |
| `source_hash` | `TEXT` | (可选) 源文本批次的哈希值，用于未来可能的变更检测。 |
| `translated_text`| `TEXT` | 已翻译完成的文本内容，以 JSON 数组的格式存储。 |

`PRIMARY KEY (job_id, file_path, batch_index)` 确保了每个批次的唯一性，使得工作流可以精确地判断某个批次是否已完成，从而实现跳过和续翻。

## 4. 工作流交互

1.  **任务开始**: `initial_translate.py` 为每个目标语言的翻译创建一个唯一的 `job_id`，并实例化 `ProgressDBManager`。
2.  **批次处理 (`parallel_processor.py`)**:
    - 在翻译一个批次**之前**，调用 `is_batch_completed()` 检查数据库中是否存在该 `(job_id, file_path, batch_index)` 的记录。
    - 如果存在，则跳过该批次。
    - 如果不存在，执行翻译。成功后，调用 `add_batch_result()` 将翻译结果（`translated_text`）**立即写入**数据库。
3.  **文件组装 (`file_aggregator.py`)**:
    - 在所有批次都写入数据库后，调用 `get_all_completed_batches_for_job()` 获取该 `job_id` 的所有记录。
    - 按 `file_path` 对记录进行分组。
    - 对每个文件内的批次按 `batch_index` 升序排序。
    - 拼接 `translated_text`，重建最终的翻译文件。
4.  **任务结束**:
    - 在文件组装**完全成功**后，工作流会调用 `cleanup_job_data()`，将该 `job_id` 的所有相关记录从数据库中删除。

## 5. 维护指南

- **可以安全删除吗？**
  - **可以**。`translation_progress.sqlite` 文件可以随时安全地删除，**前提是没有正在进行的翻译任务**。
  - 如果在翻译过程中删除了它，正在运行的任务会失败，但下次重新运行时，它会从头开始（因为找不到任何已完成的进度）。
  - 如果任务已意外中断，**不要删除**此文件。下次使用相同的参数重新运行任务时，工作流将利用此文件中的记录来恢复进度。

- **数据库会无限增长吗？**
  - **不会**。在每次翻译任务成功完成后，与该任务 (`job_id`) 相关的所有数据都会被自动清理。数据库的大小通常会保持在一个较低的水平。只有在大量任务异常中断时，才会累积未清理的数据。

- **手动清理**:
  - 如果你确定没有任何需要恢复的任务，可以直接删除 `data/translation_progress.sqlite` 文件来释放空间。程序会在下次需要时自动重建它。
