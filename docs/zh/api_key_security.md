# API 密钥存储安全升级说明

## 1. 背景与动机

在早期的开发阶段，为了方便调试，我们使用 `.env` 文件来存储 API 密钥。然而，随着项目向**本地桌面应用 (Native Desktop App)** 转型，明文存储 API 密钥（即使是在 `.env` 文件中）带来了显著的安全隐患：

*   **泄露风险**：用户在打包项目文件（如为了反馈 BUG）时，极易无意中包含 `.env` 文件，导致密钥泄露。
*   **工程兼容性**：使用系统级凭据管理器（如 Windows Credential Manager）虽然安全，但可能在精简版系统或特定企业策略下导致应用崩溃，且增加了打包复杂度。

因此，我们决定采用一种**折中且稳健**的方案：将 API 密钥存储在用户的 **AppData** 目录下。

## 2. 技术实现

我们不再依赖第三方库（如 `keyring`），而是使用标准的 JSON 文件读写。

### 2.1 存储位置

配置文件存储在用户的漫游数据目录中，路径通常为：
`C:\Users\{Username}\AppData\Roaming\Remis\config.json`

**优势：**
*   **隐蔽性**：该目录位于系统深处，用户打包 Mod 文件夹或上传 GitHub 时，绝对不会包含此文件。
*   **无需权限**：读写 AppData 不需要管理员权限，避免了修改系统环境变量带来的权限问题。
*   **零依赖**：仅使用 Python 标准库 `json` 和 `os`，无需引入可能导致打包问题的第三方库。

### 2.2 存储机制 (`scripts/web_server.py`)

当用户在前端“API 设置”页面更新密钥时，后端会将密钥写入 `config.json` 的 `api_keys` 字段中：

```json
{
    "api_keys": {
        "gemini": "AIzaSy...",
        "openai": "sk-..."
    }
}
```

### 2.3 读取机制 (`scripts/app_settings.py`)

我们实现了一个新的辅助函数 `get_api_key`，它采用以下优先级读取密钥：

1.  **AppData Config** (最高优先级)：尝试从 `config.json` 中读取。
2.  **环境变量 / .env** (兼容性回退)：如果配置文件中没有找到（例如开发者手动在 `.env` 中配置），则回退读取环境变量。

### 2.4 兼容性注入

为了确保依赖环境变量的第三方 SDK（如 Google Gemini CLI）能正常工作，我们在服务器启动时会自动读取 `config.json` 中的密钥，并将其注入到当前进程的 `os.environ` 中。

## 3. 对用户和开发者的影响

*   **普通用户**：无需任何操作。在设置页面输入密钥后，密钥将被安全存储在 AppData 中。即使将整个软件文件夹发送给他人，密钥也不会泄露。
*   **开发者**：依然可以使用 `.env` 文件进行本地调试，但建议通过 UI 界面将密钥迁移至 AppData 配置以测试真实环境。

## 4. 依赖变更

*   移除 Python 依赖：`keyring`
