# P社Mod本地化工厂 - 智能体开发规章 (Agent Development Regulations) V1.0

## 致所有协助本项目开发的AI智能体

欢迎来到 **P社Mod本地化工厂 (Paradox Mod Localization Factory)**。本项目是一个为P社游戏（如维多利亚3、群星、钢铁雄心4等）Mod提供高效、可靠的半自动本地化解决方案的Python工具。为了确保项目代码的质量、可维护性以及风格的统一，所有贡献者（包括你，AI）都必须严格遵守以下开发规章。

这些规章是我们经过大量实践总结出的最佳实践，是你在这个项目中进行任何代码生成、重构或修复工作的最高行动纲领。
## 第一章：架构总则 (Architectural Principles)

### 第一条：严格的前后端分离
本项目的核心哲学是将**表现层（UI）与业务逻辑（核心引擎）**彻底分离。

- **UI层 (ui/ 目录)**: 负责且仅负责用户界面的构建与用户交互。它应该是"愚笨的"，其唯一任务是收集用户输入，然后调用一个单一的、高级的核心函数。UI层严禁包含任何复杂的业务逻辑或编排多个核心操作。
- **核心引擎 (core/ 目录)**: 负责所有实际工作，包括文件解析、AI翻译、词典管理、文件重建和本地化处理。核心函数应该是自包含的、高级的服务。

### 第二条：单一入口点原则 (The "One Button, One Function" Rule)
对于任何一个核心的用户操作（如"开始翻译"），UI按钮的点击事件，必须只调用核心引擎中的一个高级函数（例如 `initial_translate.start_translation(...)`）。

严禁出现UI调用`file_parser.parse()`，然后调用`api_handler.translate()`，再调用`file_builder.build()`的"过程式"编排。所有工作流的编排必须在核心引擎中完成。

### 第三条：模块化与代码复用
- **新功能即新模块**: 任何新的、独立的功能（如"词典管理"、"并行处理"），都应该在一个全新的模块文件中实现。
- **提取通用工具**: 任何可能被多个模块复用的功能（如文本清理、标点符号处理、日志记录），都必须被提取到通用的工具模块中（例如 `utils/text_clean.py`, `utils/punctuation_handler.py`），以遵循**DRY (Don't Repeat Yourself)**原则。
## 第二章：命令行界面特定法规 (CLI-Specific Laws)

### 第四条：命令行交互模式
本项目采用命令行界面（CLI）作为主要用户交互方式。所有在 `ui/` 目录下用于创建用户界面的函数，都应该遵循以下原则：

- **清晰的用户提示**: 所有用户交互都应该有清晰、友好的提示信息
- **输入验证**: 对用户输入进行严格的验证，提供有意义的错误信息
- **进度反馈**: 对于耗时操作，必须提供清晰的进度指示

### 第五条：状态管理
所有需要在不同操作之间持久化的数据（如选择的游戏、API配置、翻译进度），必须使用配置文件或状态变量进行管理。严禁依赖临时文件路径。
## 第三章：代码质量与风格法典 (Code Quality Codex)

### 第六条：国际化 (i18n) 优先
所有面向用户的字符串（包括提示信息、错误消息、日志信息），严禁在Python代码中硬编码。

所有字符串必须通过 `utils.i18n._()` 函数进行包装，例如 `print(_("messages.translation_started"))`。对应的文本内容，必须在 `data/lang/` 目录下的 `en_US.json` 和 `zh_CN.json` 文件中进行定义。

### 第七条："冰山"日志哲学
本项目追求**"界面简洁，后端详细"**的设计哲学。

- **用户界面**: 必须保持界面简洁、优雅，只向用户展示最终结果和最必要的状态。
- **后端处理**: 在执行任何耗时或复杂的后端操作时，必须在命令行界面中打印出详细的、有意义的进度信息和提示。这对于调试和理解程序状态至关重要。

### 第八条：依赖管理与稳定性
- **依赖管理**: 任何新的库依赖，都必须添加到 `requirements.txt` 文件中。
- **稳定性优先**: 稳定性高于一切。如果一个外部依赖库被证明不稳定或难以集成，允许且鼓励用一个更简单的、内部实现的方案来替代它，只要该方案能满足项目的核心需求。

### 第九条：注释与文档
- **代码注释**: 所有核心函数和复杂逻辑，都必须附有清晰的Docstring或中文注释，解释其功能、参数和返回值。
- **自解释代码**: 代码应当是自解释的，但必要的注释能极大地帮助未来的维护工作。

## 第四章：P社游戏特定规范 (Paradox Games Specific Rules)

### 第十条：文件格式处理规范
本项目专门处理P社游戏的本地化文件，必须严格遵循以下规范：

- **YAML文件解析**: 必须正确处理P社特有的YAML格式（如 `key:0 "value"`），使用项目内置的 `file_parser.py` 进行解析
- **编码处理**: 所有文件操作必须使用UTF-8编码，确保中文字符正确显示
- **文件结构保持**: 重建文件时必须完美保留原始文件的缩进、注释和复杂的键名格式

### 第十一条：词典系统规范
- **术语一致性**: 所有翻译必须通过词典系统确保游戏术语的一致性
- **词典加载**: 必须使用 `glossary_manager.py` 加载对应游戏的词典文件
- **术语注入**: 在AI翻译请求中必须注入相关术语作为高优先级指令

### 第十二条：多语言支持规范
- **语言配置**: 所有支持的语言必须在 `config.py` 中的 `LANGUAGES` 字典中定义
- **文件命名**: 输出文件必须遵循P社游戏的命名规范（如 `modname_l_chinese.yml`）
- **文件夹结构**: 必须按照游戏要求创建正确的文件夹结构

## 第五章：资源管理规范 (Resource Management Rules)

### 第十三条：内存管理
- **文件句柄**: 所有文件操作必须使用 `with` 语句确保文件正确关闭
- **大文件处理**: 对于大型本地化文件，必须使用分批处理机制
- **临时文件**: 临时文件使用完毕后必须及时清理

### 第十四条：错误处理
- **API调用**: 所有API调用必须包含重试机制和错误处理
- **文件操作**: 文件读写操作必须包含异常处理
- **用户反馈**: 所有错误都必须向用户提供有意义的错误信息

---

**P社Mod本地化工厂开发团队**  
**版本 1.0.5 | 最后更新：2025-01-12**

